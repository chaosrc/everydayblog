{"componentChunkName":"component---src-templates-blog-post-js","path":"/go-example/go-exmaple-3/","webpackCompilationHash":"244ee56c36e36966767c","result":{"data":{"site":{"siteMetadata":{"title":"温故而知新","author":"chao"}},"markdownRemark":{"id":"d515ae7c-7b8b-547c-a6d6-a3891faf667b","excerpt":"Go 实战（三）使用数据库jwt 认证","html":"<h2>Go 实战（三）</h2>\n<h4>使用数据库</h4>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> common\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\n\t<span class=\"token string\">\"github.com/jinzhu/gorm\"</span>\n\t<span class=\"token comment\">// 使用sqlite3</span>\n\t<span class=\"token boolean\">_</span> <span class=\"token string\">\"github.com/jinzhu/gorm/dialects/sqlite\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> Database <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token operator\">*</span>gorm<span class=\"token punctuation\">.</span>DB\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> DB <span class=\"token operator\">*</span>gorm<span class=\"token punctuation\">.</span>DB\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">Init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>gorm<span class=\"token punctuation\">.</span>DB <span class=\"token punctuation\">{</span>\n\n\tdb<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> gorm<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sqlite3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"../gorm.db\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"db err: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tdb<span class=\"token punctuation\">.</span><span class=\"token function\">DB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">SetConnMaxLifetime</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n\tDB <span class=\"token operator\">=</span> db\n\t<span class=\"token keyword\">return</span> DB\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">GetDB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>gorm<span class=\"token punctuation\">.</span>DB <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> DB\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>jwt 认证</h4>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> users\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"strings\"</span>\n\n\t<span class=\"token string\">\"github.com/chaosrc/realworld/common\"</span>\n\t<span class=\"token string\">\"github.com/dgrijalva/jwt-go\"</span>\n\t<span class=\"token string\">\"github.com/dgrijalva/jwt-go/request\"</span>\n\t<span class=\"token string\">\"github.com/gin-gonic/gin\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 过滤掉 token 前缀</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">stripTokenString</span><span class=\"token punctuation\">(</span>token <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">5</span> <span class=\"token operator\">&amp;&amp;</span> strings<span class=\"token punctuation\">.</span><span class=\"token function\">ToUpper</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"TOKEN\"</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> token<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> token<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 获取 header 的 Authorization，并过滤掉 token 前缀</span>\n<span class=\"token keyword\">var</span> AuthorizationHeaderExtractor <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>request<span class=\"token punctuation\">.</span>PostExtractionFilter<span class=\"token punctuation\">{</span>\n\trequest<span class=\"token punctuation\">.</span>HeaderExtractor<span class=\"token punctuation\">{</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\tstripTokenString<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 提取 OAuth2 访问 token。先获取 header 的 Authorization ，</span>\n<span class=\"token comment\">// 然后再获取其中的 access_token</span>\n<span class=\"token keyword\">var</span> MyAuth2Extractor <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>request<span class=\"token punctuation\">.</span>MultiExtractor<span class=\"token punctuation\">{</span>\n\tAuthorizationHeaderExtractor<span class=\"token punctuation\">,</span>\n\trequest<span class=\"token punctuation\">.</span>ArgumentExtractor<span class=\"token punctuation\">{</span><span class=\"token string\">\"access_token\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">UpdateContextUserModel</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> myUserId <span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> myUserModel UserModel\n\n\t<span class=\"token keyword\">if</span> myUserId <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n\t\tdb <span class=\"token operator\">:=</span> common<span class=\"token punctuation\">.</span><span class=\"token function\">GetDB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\tdb<span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>myUserModel<span class=\"token punctuation\">,</span> myUserId<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tc<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"my_user_id\"</span><span class=\"token punctuation\">,</span> myUserId<span class=\"token punctuation\">)</span>\n\tc<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"my_user_model\"</span><span class=\"token punctuation\">,</span> myUserModel<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">AuthMiddleware</span><span class=\"token punctuation\">(</span>auth401 <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> gin<span class=\"token punctuation\">.</span>HandlerFunc <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">UpdateContextUserModel</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\t\ttoken<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">ParseFromRequest</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">,</span> MyAuth2Extractor<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>token <span class=\"token operator\">*</span>jwt<span class=\"token punctuation\">.</span>Token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tb <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"awejiqwieijwiqoewjqowe\"</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> b<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">if</span> auth401 <span class=\"token punctuation\">{</span>\n\t\t\t\tc<span class=\"token punctuation\">.</span><span class=\"token function\">AbortWithError</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusUnauthorized<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token keyword\">return</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">if</span> claims<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> token<span class=\"token punctuation\">.</span>Claims<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">.</span>MapClaims<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ok <span class=\"token operator\">&amp;&amp;</span> token<span class=\"token punctuation\">.</span>Valid <span class=\"token punctuation\">{</span>\n\t\t\tmyUserId <span class=\"token operator\">:=</span> <span class=\"token function\">uint</span><span class=\"token punctuation\">(</span>claims<span class=\"token punctuation\">[</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">float64</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token function\">UpdateContextUserModel</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> myUserId<span class=\"token punctuation\">)</span>\n\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Go 实战（三）","date":"December 18, 2019","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/go-example/go-exmaple-3/","previous":{"fields":{"slug":"/go-example/go-example-1/"},"frontmatter":{"title":"Golang 实战（一）"}},"next":{"fields":{"slug":"/go-example/go-example.4/"},"frontmatter":{"title":"Go 实战（四）"}}}}}