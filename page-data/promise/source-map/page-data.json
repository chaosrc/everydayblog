{"componentChunkName":"component---src-templates-blog-post-js","path":"/promise/source-map/","webpackCompilationHash":"244ee56c36e36966767c","result":{"data":{"site":{"siteMetadata":{"title":"温故而知新","author":"chao"}},"markdownRemark":{"id":"12bf7ffb-3dad-586f-a648-a7428d2c948c","excerpt":"在 Node.js 中使用 Source Map为了减少代码体积或者编译成兼容性更好的低版本代码，通常需要压缩和编译代码，但是会导致在出现错误时无法对错误进行定位，通过 Source Map 工具可以解决这个问题。下面将会介绍 uglify-es 和 tyescript 编译后如何使用 Source Map…","html":"<h2>在 Node.js 中使用 Source Map</h2>\n<p>为了减少代码体积或者编译成兼容性更好的低版本代码，通常需要压缩和编译代码，但是会导致在出现错误时无法对错误进行定位，通过 Source Map 工具可以解决这个问题。下面将会介绍 uglify-es 和 tyescript 编译后如何使用 Source Map 工具定位错误</p>\n<h4>uglify-es</h4>\n<p>uglify-js 是常用的 Javascript 代码压缩工具，但是支持到 ES 5 的版本。uglify-es 支持 ES 6 及以上版本并且兼容 uglify-js。</p>\n<p>使用 source-map-support 模块可以使 Node.js 支持 source-map。</p>\n<p>安装 uglify-es 和 source-map-support</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">$ npm i uglify<span class=\"token operator\">-</span>es source<span class=\"token operator\">-</span>map<span class=\"token operator\">-</span>support</code></pre></div>\n<p>创建测试代码</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'source-map-support'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>在代码顶部引入 source-map-support 模块并执行 install 方法，执行 start 方法调用 a 方法抛出错误</p>\n<p>使用 uglify-es 压缩代码</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ node_modules/.bin/uglifyjs app.js -o app.min.js --source-map <span class=\"token string\">\"url=app.min.js.map\"</span></code></pre></div>\n<p>得到压缩代码 app.min.js 以及其 map 文件 app.min.js.map</p>\n<p>app.min.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"source-map-support\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">function</span> <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token keyword\">function</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//# sourceMappingURL=app.min.js.map</span></code></pre></div>\n<p>app.min.js.map</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"sources\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"app.js\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"names\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"require\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"install\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"Error\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"console\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"log\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"mappings\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"AAAAA,QAAQ,sBAAsBC,UAG9B,SAASC,IACL,MAAM,IAAIC,MAAM,SAChBC,QAAQC,IAAI,SAGhB,SAASC,QACLJ,IAGJI\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>运行 app.min.js </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ node app.min.js\n/Users/chao/workspace/node/node-demo/promise/source-map/app.js:5\n    throw new Error<span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">)</span>\n          ^\nError: error\n    at a <span class=\"token punctuation\">(</span>/Users/chao/workspace/node/node-demo/promise/source-map/app.js:5:11<span class=\"token punctuation\">)</span>\n    at start <span class=\"token punctuation\">(</span>/Users/chao/workspace/node/node-demo/promise/source-map/app.js:5:5<span class=\"token punctuation\">)</span>\n    at Object.<span class=\"token operator\">&lt;</span>anonymous<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>/Users/chao/workspace/node/node-demo/promise/source-map/app.js:5:5<span class=\"token punctuation\">)</span></code></pre></div>\n<p>可以看到 start 到 a 的调用栈，以及出现错误的位置 app.js 的第 5 行</p>\n<p>如果不实用 source-map，即去掉代码中的 <code class=\"language-text\">require(&#39;source-map-support&#39;).install()</code></p>\n<p>再运行</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ node app.min.js/Users/chao/workspace/node/node-demo/promise/source-map/app.min.js:1\nfunction a(){throw new Error(&quot;error&quot;)}function start(){a()}start();\n             ^\n\nError: error\n    at a (/Users/chao/workspace/node/node-demo/promise/source-map/app.min.js:1:20)\n    at start (/Users/chao/workspace/node/node-demo/promise/source-map/app.min.js:1:56)</code></pre></div>\n<p>无法正确的显示出现错误的位置</p>\n<h4>Typescript</h4>\n<p>创建测试代码</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token string\">'source-map-support/register'</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Foo</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Foo new error'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>使用 Typescript 的编译工具 tsc 编译</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">tsc --sourceMap app_ts.ts</code></pre></div>\n<p>运行生成的 app_ts.js</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ node app_ts.js\n\n/Users/chao/workspace/node/node-demo/promise/source-map/app_ts.ts:5\n        throw new Error<span class=\"token punctuation\">(</span><span class=\"token string\">'Foo new error'</span><span class=\"token punctuation\">)</span>\n              ^\nError: Foo new error\n    at new Foo <span class=\"token punctuation\">(</span>/Users/chao/workspace/node/node-demo/promise/source-map/app_ts.ts:5:15<span class=\"token punctuation\">)</span>\n    at Object.<span class=\"token operator\">&lt;</span>anonymous<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>/Users/chao/workspace/node/node-demo/promise/source-map/app_ts.ts:9:1<span class=\"token punctuation\">)</span>\n    at Module._compile <span class=\"token punctuation\">(</span>internal/modules/cjs/loader.js:778:30<span class=\"token punctuation\">)</span></code></pre></div>\n<p>也可以正确定位到错误位置</p>","frontmatter":{"title":"在 Node.js 中使用 Source Map","date":"August 21, 2019","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/promise/source-map/","previous":{"fields":{"slug":"/promise/erro-stack/"},"frontmatter":{"title":"Node.js 错误栈"}},"next":{"fields":{"slug":"/promise/devtools/"},"frontmatter":{"title":"使用 Chrome DevTools 调试 Node.js 程序"}}}}}