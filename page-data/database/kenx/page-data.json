{"componentChunkName":"component---src-templates-blog-post-js","path":"/database/kenx/","webpackCompilationHash":"244ee56c36e36966767c","result":{"data":{"site":{"siteMetadata":{"title":"温故而知新","author":"chao"}},"markdownRemark":{"id":"eaa2338e-bcc5-536a-9e33-692ecf6dd2f9","excerpt":"SQL 查询构建器 KnexKnex 是一个功能完备的SQL查询构建器支持Postgres, MSSQL, MySQL, MariaDB, SQLite3, Oracle等数据库。\nKnex 既支持传统的 Node.js 风格的回调，也支持 Promise 来进行异步流程控制。Knex 是一个轻量级的 SQL…","html":"<h2>SQL 查询构建器 Knex</h2>\n<p>Knex 是一个功能完备的SQL查询构建器支持Postgres, MSSQL, MySQL, MariaDB, SQLite3, Oracle等数据库。\nKnex 既支持传统的 Node.js 风格的回调，也支持 Promise 来进行异步流程控制<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>。Knex 是一个轻量级的 SQL 抽象包，可以通过它的声明式 API 构建出 SQL 字符串</p>\n<h4>安装 Knex</h4>\n<p>安装 knex 模块</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> knex</code></pre></div>\n<p>安装数据库客户端模块</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># PostgresSQL</span>\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> pg\n\n<span class=\"token comment\"># MyMySQL</span>\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> mysql\n\n<span class=\"token comment\"># sqlite3</span>\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> sqllite3</code></pre></div>\n<h4>连接数据库</h4>\n<p>连接 Postgres</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> knex <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'knex'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> pg <span class=\"token operator\">=</span> <span class=\"token function\">knex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    client<span class=\"token punctuation\">:</span> <span class=\"token string\">\"pg\"</span><span class=\"token punctuation\">,</span>\n    connection<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        host<span class=\"token punctuation\">:</span> <span class=\"token string\">'***.***.***.***'</span><span class=\"token punctuation\">,</span>\n        user<span class=\"token punctuation\">:</span> <span class=\"token string\">'postgres'</span><span class=\"token punctuation\">,</span>\n        password<span class=\"token punctuation\">:</span> <span class=\"token string\">'123456'</span><span class=\"token punctuation\">,</span>\n        pool<span class=\"token punctuation\">:</span> <span class=\"token string\">'5432'</span><span class=\"token punctuation\">,</span>\n        database<span class=\"token punctuation\">:</span> <span class=\"token string\">'articles'</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>连接 MySQL</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mysql <span class=\"token operator\">=</span> <span class=\"token function\">knex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    client<span class=\"token punctuation\">:</span> <span class=\"token string\">'mysql'</span><span class=\"token punctuation\">,</span>\n    connection<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        host<span class=\"token punctuation\">:</span> <span class=\"token string\">'***.***.***.***'</span><span class=\"token punctuation\">,</span>\n        user<span class=\"token punctuation\">:</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span>\n        password<span class=\"token punctuation\">:</span> <span class=\"token string\">'123456'</span><span class=\"token punctuation\">,</span>\n        port<span class=\"token punctuation\">:</span> <span class=\"token string\">'3306'</span><span class=\"token punctuation\">,</span>\n        database<span class=\"token punctuation\">:</span> <span class=\"token string\">'test'</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>连接 sqlite</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> sqlite <span class=\"token operator\">=</span> <span class=\"token function\">knex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    client<span class=\"token punctuation\">:</span> <span class=\"token string\">\"sqlite3\"</span><span class=\"token punctuation\">,</span>\n    connection<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        filename<span class=\"token punctuation\">:</span> __dirname <span class=\"token operator\">+</span> <span class=\"token string\">'/articles.db'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    useNullAsDefault<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4>使用 Knex 进行查询</h4>\n<p>创建表</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">createTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">'student'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">table</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">increments</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">primary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token string\">'address'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>插入数据</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> insert <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">db</span><span class=\"token punctuation\">(</span><span class=\"token string\">'student'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">:</span> <span class=\"token string\">'shanghai'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>insert<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 输出： [ 1 ]</span></code></pre></div>\n<p>查询数据</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> find <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">db</span><span class=\"token punctuation\">(</span><span class=\"token string\">'student'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>find<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 输出： [ { id: 1, name: 'foo', address: 'shanghai' } ]</span></code></pre></div>\n<p>删除数据</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> del <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">db</span><span class=\"token punctuation\">(</span><span class=\"token string\">'student'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">del</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>id<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>del<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 输出： 1</span></code></pre></div>\n<p>通过 knex 查询构建器能够支持多种数据库同时消除了各种 SQL 方言的差异，提供同样的接口，方便在不同的数据库之间进行切换</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p><a href=\"https://knexjs.org/\">https://knexjs.org/</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","frontmatter":{"title":"查询构建器 Knex","date":"July 21, 2019","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/database/kenx/","previous":{"fields":{"slug":"/database/PostgreSQL/"},"frontmatter":{"title":"PostgreSQL 简单使用"}},"next":{"fields":{"slug":"/database/mongodb/"},"frontmatter":{"title":"MongoDB 简介"}}}}}